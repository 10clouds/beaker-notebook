machine:
  services:
    - docker
  environment:
    TAG: "${CIRCLE_SHA1:0:7}"
    REGISTRY: quay.io/mojotech

dependencies:
  override:
    - make bootstrap-ci
    - elasticsearch-1.3.4/bin/elasticsearch:
        background: true
    - sudo haproxy -db -f haproxy/haproxy.cfg:
        background: true
    - make -j8 all

database:
  override:
    - sudo su postgres -c "createdb -e bunsen_test"

test:
  override:
    - make HOST="127.0.0.1" test-vendor test-user test-integration

deployment:
  staging:
    branch: staging
    commands:
      - docker login -e="." -u="$QUAY_USER" -p "$QUAY_PASS" "$QUAY_HOST"
      - make push-all:
          timeout: 360
      - make deploy-staging:
          timeout: 360
