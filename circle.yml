machine:
  services:
    - docker
  environment:
    TAG: "${CIRCLE_SHA1:0:7}"
    REGISTRY: quay.io/mojotech

dependencies:
  override:
    - make bootstrap-ci
    - elasticsearch-1.3.4/bin/elasticsearch:
        background: true
    - sudo BEAKER_SERVER="127.0.0.1:8801" make -C haproxy run:
        background: true
    - make -j2 all prepare-beaker

test:
  override:
    - make BUNSEN_URI="http://172.17.42.1:9000/" test-integration

deployment:
  staging:
    branch: staging
    commands:
      - docker login -e="." -u="$QUAY_USER" -p "$QUAY_PASS" "$QUAY_HOST"
      - make push-all:
          timeout: 360
      - make deploy-bunsen-staging:
          timeout: 360
