/*
 *      Copyright (c) 2013 Two Sigma Investments, LLC
 *      All Rights Reserved
 *
 *      THIS IS UNPUBLISHED PROPRIETARY SOURCE CODE OF
 *      Two Sigma Investments, LLC.
 *
 *      The copyright notice above does not evidence any
 *      actual or intended publication of such source code.
 */
package com.twosigma.beaker.rest;

/*
 * Watch the output of the R process and capture the part between
 * magic patterns and pass that back as results to a
 * SimpleEvaluationObject, otherwise just pass it on as output.
 */

import com.twosigma.beaker.jvm.object.SimpleEvaluationObject;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;

public class ROutputHandler extends Thread {

    private InputStream _stream;
    private String _captured;
    private boolean _recording;
    private SimpleEvaluationObject _dest;
    private String _beginMagic;
    private String _endMagic;

    public ROutputHandler(InputStream stream, String beginMagic, String endMagic) {
        _stream = stream;
        _recording = false;
        _captured = null;
        _beginMagic = beginMagic;
        _endMagic = endMagic;
    }

    public void reset(SimpleEvaluationObject dest) {
        _dest = dest;
    }

    public void run() {

        try {
            BufferedReader br = new BufferedReader(new InputStreamReader(_stream));

            String line = null;
            while ((line = br.readLine()) != null) {
                if (line.indexOf(_beginMagic) >= 0) {
                    _recording = true;
                } else if (line.indexOf(_endMagic) >= 0) {
                    _dest.finished(_captured);
                    _dest = null;
                    _captured = null;
                    _recording = false;
                } else if (_recording) {
                    if (null == _captured)
                        _captured = line;
                    else
                        _captured = _captured + "\n" + line;
                } else
                    System.out.println(line);
            }
        } catch (IOException ioe) {
            ioe.printStackTrace();
        }
    }
}
